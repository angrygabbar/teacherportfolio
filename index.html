<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Developer Portal</title>
    
    <!-- Tailwind CSS -->
    <script src="https://cdn.tailwindcss.com"></script>
    
    <!-- React Libraries -->
    <script src="https://unpkg.com/react@17/umd/react.development.js"></script>
    <script src="https://unpkg.com/react-dom@17/umd/react-dom.development.js"></script>
    
    <!-- Babel to transpile JSX in the browser -->
    <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>
    
    <!-- Supabase Client Library -->
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>

    <style>
        @keyframes fadeIn { from { opacity: 0; transform: translateY(10px); } to { opacity: 1; transform: translateY(0); } }
        .animate-fade-in { animation: fadeIn 0.5s ease-out forwards; }
        @keyframes slideIn { from { opacity: 0; transform: translateX(-20px); } to { opacity: 1; transform: translateX(0); } }
        .animate-slide-in { animation: slideIn 0.5s ease-out forwards; }
        body {
            font-family: sans-serif;
        }
    </style>
</head>
<body class="bg-gray-50 dark:bg-gray-900">
    <div id="root"></div>

    <script type="text/babel">
        // --- Supabase Client Setup ---
        const { createClient } = supabase;
        const supabaseUrl = 'https://iogreytkiypwibfuuwrk.supabase.co';
        const supabaseAnonKey = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6ImlvZ3JleXRraXlwd2liZnV1d3JrIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NTQ4MzgxMDYsImV4cCI6MjA3MDQxNDEwNn0.VH-0k9twTjfhLMTTzroI4IMh6pkPGm3G0cL3rUHe5HU';
        const supabaseClient = createClient(supabaseUrl, supabaseAnonKey);

        // --- Helper Components ---
        const Icon = ({ path, className = "w-6 h-6" }) => (
            <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" strokeWidth={1.5} stroke="currentColor" className={className}>
                <path strokeLinecap="round" strokeLinejoin="round" d={path} />
            </svg>
        );

        const Spinner = () => (
            <div className="animate-spin rounded-full h-8 w-8 border-b-2 border-white"></div>
        );

        // --- Navigation Component ---
        const Navbar = ({ user, onLogout, setPage, currentPage }) => {
            const NavLink = ({ pageName, children }) => {
                const isActive = currentPage === pageName;
                return (
                    <button 
                        onClick={() => setPage(pageName)}
                        className={`px-3 py-2 rounded-md text-sm font-medium transition-colors duration-300 relative group ${
                            isActive 
                            ? 'text-indigo-600 dark:text-indigo-400' 
                            : 'text-gray-700 dark:text-gray-300 hover:text-indigo-600 dark:hover:text-indigo-400'
                        }`}
                    >
                        {children}
                        <span className={`absolute bottom-0 left-0 w-full h-0.5 bg-indigo-600 dark:bg-indigo-400 transform scale-x-0 group-hover:scale-x-100 transition-transform duration-300 ${isActive ? 'scale-x-100' : ''}`}></span>
                    </button>
                );
            };

            return (
                <header className="bg-white/80 dark:bg-gray-800/80 shadow-md sticky top-0 z-40 backdrop-blur-sm">
                    <div className="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8">
                        <div className="flex items-center justify-between h-16">
                            <div className="flex items-center cursor-pointer" onClick={() => setPage('home')}>
                                <Icon path="M10 20l4-16m4 4l4 4-4 4M6 16l-4-4 4-4" className="w-8 h-8 text-indigo-500" />
                                <h1 className="ml-3 text-2xl font-bold text-gray-900 dark:text-white">DevPortal</h1>
                            </div>
                            <nav className="hidden md:flex items-center space-x-4">
                                <NavLink pageName="home">Home</NavLink>
                                <NavLink pageName="contact">Contact Us</NavLink>
                                {user && <NavLink pageName="dashboard">Dashboard</NavLink>}
                            </nav>
                            <div className="flex items-center">
                                {user ? (
                                    <button
                                        onClick={onLogout}
                                        className="flex items-center bg-indigo-600 text-white px-4 py-2 rounded-md hover:bg-indigo-700 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-indigo-500 transition-transform duration-200 hover:scale-105"
                                    >
                                    <Icon path="M15.75 9V5.25A2.25 2.25 0 0013.5 3h-6a2.25 2.25 0 00-2.25 2.25v13.5A2.25 2.25 0 007.5 21h6a2.25 2.25 0 002.25-2.25V15M12 9l-3 3m0 0l3 3m-3-3h12.75" className="w-5 h-5 mr-2" />
                                        Logout
                                    </button>
                                ) : (
                                    <button onClick={() => setPage('login')} className="bg-indigo-600 text-white px-5 py-2 rounded-md hover:bg-indigo-700 transition-all duration-300 hover:shadow-lg hover:shadow-indigo-500/50 transform hover:scale-105">
                                        Login / Register
                                    </button>
                                )}
                            </div>
                        </div>
                    </div>
                </header>
            );
        };

        // --- Page Components ---
        const HomePage = ({ setPage }) => (
            <div className="animate-fade-in space-y-16">
                <div className="text-center py-16 px-4 sm:px-6 lg:px-8 bg-white dark:bg-gray-800/50 rounded-lg shadow-xl overflow-hidden relative">
                    <div className="relative">
                        <div className="w-24 h-24 mx-auto text-indigo-500">
                            <svg viewBox="0 0 100 100" xmlns="http://www.w3.org/2000/svg">
                              <style>{`.path{animation:dash 4s linear infinite;}@keyframes dash{to{stroke-dashoffset: -1000;}}`}</style>
                              <path className="path" fill="none" stroke="currentColor" strokeWidth="2" strokeDasharray="500" d="M20,50 C20,20 80,20 80,50 C80,80 20,80 20,50 Z" />
                              <path className="path" style={{animationDelay: '-2s'}} fill="none" stroke="currentColor" strokeWidth="2" strokeDasharray="500" d="M50,20 C80,20 80,80 50,80 C20,80 20,20 50,20 Z" />
                            </svg>
                        </div>
                        <h2 className="mt-6 text-4xl font-extrabold text-gray-900 dark:text-white sm:text-5xl tracking-tight">Forge the Future, Together.</h2>
                        <p className="mt-4 max-w-2xl mx-auto text-xl text-gray-500 dark:text-gray-300">
                            The central hub for our development team. Manage daily updates, track progress, and onboard new talent seamlessly.
                        </p>
                        <div className="mt-8">
                            <button
                                onClick={() => setPage('login')}
                                className="inline-flex items-center justify-center px-8 py-3 border border-transparent text-base font-medium rounded-md text-white bg-indigo-600 hover:bg-indigo-700 transform transition-transform duration-300 hover:scale-105"
                            >
                                Get Started
                            </button>
                        </div>
                    </div>
                </div>
                
                <div className="bg-white dark:bg-gray-800/50 rounded-lg shadow-xl p-8 md:p-12 animate-fade-in" style={{animationDelay: '0.2s'}}>
                    <h3 className="text-3xl font-bold text-center text-gray-900 dark:text-white">Our Vision</h3>
                    <p className="mt-4 max-w-3xl mx-auto text-center text-lg text-gray-600 dark:text-gray-400">
                        To cultivate a collaborative ecosystem where innovation thrives, developers are empowered, and technology creates meaningful impact. We believe in writing code that is not only functional but elegant, and building a team that is not just productive but also supportive and forward-thinking.
                    </p>
                </div>

                <div className="animate-fade-in" style={{animationDelay: '0.4s'}}>
                    <h3 className="text-3xl font-bold text-center text-gray-900 dark:text-white mb-12">Built for Developers, by Developers</h3>
                    <div className="grid grid-cols-1 md:grid-cols-3 gap-8">
                        <FeatureCard 
                            iconPath="M17.25 6.75c0 3.142-2.558 5.75-5.75 5.75S5.75 9.892 5.75 6.75 8.308 1 11.5 1s5.75 2.558 5.75 5.75z"
                            title="Streamlined Workflow"
                            description="Post daily updates in seconds. Keep the team in sync without the meeting fatigue. Focus on what you do best: coding."
                        />
                        <FeatureCard 
                            iconPath="M10 20l4-16m4 4l4 4-4 4M6 16l-4-4 4-4"
                            title="Transparent Progress"
                            description="Get a real-time view of the entire team's activity. Understand dependencies and celebrate collective achievements."
                        />
                        <FeatureCard 
                            iconPath="M18 18.72a9.094 9.094 0 003.741-.479 3 3 0 00-4.682-2.72m-7.5-2.962c.51.056 1.02.082 1.5.082a9.091 9.091 0 005.686-1.712A3 3 0 0013.17 4.97a3 3 0 00-4.682 2.72"
                            title="Seamless Onboarding"
                            description="A simple, clear path for new candidates to join the team. Admins can review and approve applications all in one place."
                        />
                    </div>
                </div>
            </div>
        );

        const FeatureCard = ({ iconPath, title, description }) => (
            <div className="bg-white dark:bg-gray-800 p-6 rounded-lg shadow-lg transform transition-transform duration-300 hover:-translate-y-2 hover:shadow-2xl hover:shadow-indigo-500/30">
                <div className="flex items-center justify-center h-12 w-12 rounded-md bg-indigo-500 text-white">
                    <Icon path={iconPath} className="w-6 h-6" />
                </div>
                <h4 className="mt-5 text-xl font-semibold text-gray-900 dark:text-white">{title}</h4>
                <p className="mt-2 text-base text-gray-500 dark:text-gray-400">{description}</p>
            </div>
        );

        const ContactPage = () => (
            <div className="bg-white dark:bg-gray-800 rounded-lg shadow-xl p-8 md:p-12 animate-fade-in">
                <h2 className="text-3xl font-extrabold text-center text-gray-900 dark:text-white">Contact Us</h2>
                <p className="mt-4 text-lg text-center text-gray-500 dark:text-gray-300">Have questions? We'd love to hear from you.</p>
                <div className="mt-12 grid grid-cols-1 md:grid-cols-2 gap-8">
                    <div className="bg-gray-50 dark:bg-gray-700/50 p-6 rounded-lg transform transition-transform duration-300 hover:scale-105 hover:shadow-lg">
                        <h3 className="text-xl font-bold text-gray-900 dark:text-white">General Inquiries</h3>
                        <p className="mt-2 text-gray-600 dark:text-gray-400">For all general questions and information.</p>
                        <p className="mt-4 font-semibold text-indigo-600 dark:text-indigo-400">contact@devportal.com</p>
                    </div>
                    <div className="bg-gray-50 dark:bg-gray-700/50 p-6 rounded-lg transform transition-transform duration-300 hover:scale-105 hover:shadow-lg">
                        <h3 className="text-xl font-bold text-gray-900 dark:text-white">Technical Support</h3>
                        <p className="mt-2 text-gray-600 dark:text-gray-400">Experiencing issues with the portal?</p>
                        <p className="mt-4 font-semibold text-indigo-600 dark:text-indigo-400">support@devportal.com</p>
                    </div>
                </div>
            </div>
        );

        // --- Auth Page Components ---
        const LoginPage = ({ onLogin, onRegister, error, loading }) => {
            const [mode, setMode] = React.useState('selectRole');
            const [role, setRole] = React.useState('');

            const handleRoleSelect = (selectedRole) => {
                setRole(selectedRole);
                setMode(selectedRole === 'candidate' ? 'register' : 'login');
            };

            const AuthFormCard = ({ title, children }) => (
                <div className="max-w-md mx-auto bg-white dark:bg-gray-800 shadow-2xl rounded-lg overflow-hidden">
                    <div className="p-8">
                        <h2 className="text-center text-3xl font-extrabold text-gray-900 dark:text-white">{title}</h2>
                        {children}
                    </div>
                </div>
            );

            const RoleButton = ({ iconPath, onClick, label }) => (
                <button onClick={onClick} className="w-full flex items-center justify-center p-4 border border-gray-300 dark:border-gray-600 rounded-lg text-lg font-medium text-gray-700 dark:text-gray-200 hover:bg-indigo-50 dark:hover:bg-gray-700 transition-all duration-300 transform hover:scale-105 hover:shadow-md hover:border-indigo-500">
                    <Icon path={iconPath} className="w-6 h-6 mr-3 text-indigo-500" />
                    {label}
                </button>
            );

            const LoginForm = ({ onLogin, setMode, error, loading, role }) => {
                const [email, setEmail] = React.useState('');
                const [password, setPassword] = React.useState('');
                const handleSubmit = (e) => { e.preventDefault(); onLogin(email, password); };

                return (
                    <AuthFormCard title={`${role.charAt(0).toUpperCase() + role.slice(1)} Sign In`}>
                        <form onSubmit={handleSubmit} className="mt-8 space-y-6">
                            <div className="rounded-md shadow-sm -space-y-px">
                                <input type="email" value={email} onChange={e => setEmail(e.target.value)} required className="appearance-none rounded-none relative block w-full px-3 py-2 border border-gray-300 placeholder-gray-500 text-gray-900 rounded-t-md focus:outline-none focus:ring-indigo-500 focus:border-indigo-500 sm:text-sm dark:bg-gray-700 dark:border-gray-600 dark:text-white" placeholder="Email address" />
                                <input type="password" value={password} onChange={e => setPassword(e.target.value)} required className="appearance-none rounded-none relative block w-full px-3 py-2 border border-gray-300 placeholder-gray-500 text-gray-900 rounded-b-md focus:outline-none focus:ring-indigo-500 focus:border-indigo-500 sm:text-sm dark:bg-gray-700 dark:border-gray-600 dark:text-white" placeholder="Password" />
                            </div>
                            {error && <p className="text-red-500 text-sm mt-2">{error}</p>}
                            <button type="submit" disabled={loading} className="group relative w-full flex justify-center py-2 px-4 border border-transparent text-sm font-medium rounded-md text-white bg-indigo-600 hover:bg-indigo-700 disabled:bg-indigo-400">
                                {loading ? <Spinner /> : 'Sign in'}
                            </button>
                        </form>
                        <button onClick={() => setMode('selectRole')} className="mt-4 text-sm text-indigo-600 hover:text-indigo-500">
                            &larr; Back to role selection
                        </button>
                    </AuthFormCard>
                );
            };

            const RegisterForm = ({ onRegister, setMode, error, loading }) => {
                const [name, setName] = React.useState('');
                const [email, setEmail] = React.useState('');
                const [password, setPassword] = React.useState('');
                const [resume, setResume] = React.useState(null);
                const handleSubmit = (e) => {
                    e.preventDefault();
                    const resumeInfo = resume ? { name: resume.name, size: resume.size, type: resume.type } : null;
                    onRegister(name, email, password, resumeInfo);
                };

                return (
                    <AuthFormCard title="Candidate Registration">
                        <form onSubmit={handleSubmit} className="mt-8 space-y-4">
                            <input name="name" type="text" value={name} onChange={e => setName(e.target.value)} required className="appearance-none relative block w-full px-3 py-2 border border-gray-300 placeholder-gray-500 text-gray-900 rounded-md focus:outline-none focus:ring-indigo-500 sm:text-sm dark:bg-gray-700 dark:border-gray-600 dark:text-white" placeholder="Full Name" />
                            <input name="email" type="email" value={email} onChange={e => setEmail(e.target.value)} required className="appearance-none relative block w-full px-3 py-2 border border-gray-300 placeholder-gray-500 text-gray-900 rounded-md focus:outline-none focus:ring-indigo-500 sm:text-sm dark:bg-gray-700 dark:border-gray-600 dark:text-white" placeholder="Email address" />
                            <input name="password" type="password" value={password} onChange={e => setPassword(e.target.value)} required className="appearance-none relative block w-full px-3 py-2 border border-gray-300 placeholder-gray-500 text-gray-900 rounded-md focus:outline-none focus:ring-indigo-500 sm:text-sm dark:bg-gray-700 dark:border-gray-600 dark:text-white" placeholder="Password" />
                            <div>
                                <label className="block text-sm font-medium text-gray-700 dark:text-gray-300">Resume (PDF)</label>
                                <input onChange={e => setResume(e.target.files[0])} type="file" accept=".pdf" className="mt-1 block w-full text-sm text-gray-500 file:mr-4 file:py-2 file:px-4 file:rounded-md file:border-0 file:font-semibold file:bg-indigo-50 file:text-indigo-700 hover:file:bg-indigo-100 dark:file:bg-gray-600 dark:file:text-gray-200"/>
                            </div>
                            {error && <p className="text-red-500 text-sm mt-2">{error}</p>}
                            <button type="submit" disabled={loading} className="group relative w-full flex justify-center py-2 px-4 border border-transparent text-sm font-medium rounded-md text-white bg-indigo-600 hover:bg-indigo-700 disabled:bg-indigo-400">
                                {loading ? <Spinner /> : 'Register'}
                            </button>
                        </form>
                        <button onClick={() => setMode('selectRole')} className="mt-4 text-sm text-indigo-600 hover:text-indigo-500">
                            &larr; Back to role selection
                        </button>
                    </AuthFormCard>
                );
            };

            return (
                <div className="animate-fade-in">
                    {mode === 'selectRole' && (
                        <AuthFormCard title="Select Your Role">
                            <div className="mt-8 space-y-4">
                                <RoleButton iconPath="M18 18.72a9.094 9.094 0 003.741-.479 3 3 0 00-4.682-2.72m-7.5-2.962c.51.056 1.02.082 1.5.082a9.091 9.091 0 005.686-1.712A3 3 0 0013.17 4.97a3 3 0 00-4.682 2.72m-7.5 2.962c.51.056 1.02.082 1.5.082a9.091 9.091 0 005.686-1.712A3 3 0 0013.17 4.97a3 3 0 00-4.682 2.72" onClick={() => handleRoleSelect('admin')} label="Admin Login" />
                                <RoleButton iconPath="M17.25 6.75c0 3.142-2.558 5.75-5.75 5.75S5.75 9.892 5.75 6.75 8.308 1 11.5 1s5.75 2.558 5.75 5.75zM11.5 21c3.142 0 5.75-2.558 5.75-5.75S14.642 9.5 11.5 9.5 5.75 12.058 5.75 15.25 8.308 21 11.5 21z" onClick={() => handleRoleSelect('developer')} label="Developer Login" />
                                <RoleButton iconPath="M15.75 6a3.75 3.75 0 11-7.5 0 3.75 3.75 0 017.5 0zM4.501 20.118a7.5 7.5 0 0114.998 0A17.933 17.933 0 0112 21.75c-2.676 0-5.216-.584-7.499-1.632z" onClick={() => handleRoleSelect('candidate')} label="Candidate Registration" />
                            </div>
                        </AuthFormCard>
                    )}
                    {mode === 'login' && <LoginForm onLogin={onLogin} setMode={setMode} error={error} loading={loading} role={role} />}
                    {mode === 'register' && <RegisterForm onRegister={onRegister} setMode={setMode} error={error} loading={loading} />}
                </div>
            );
        };

        // --- Dashboard Components ---
        const Dashboard = ({ user }) => (
            <div className="animate-fade-in">
                {user.role === 'admin' && <AdminDashboard />}
                {user.role === 'developer' && <DeveloperDashboard user={user} />}
                {user.role === 'candidate' && <CandidateDashboard user={user} />}
            </div>
        );

        const AdminDashboard = () => {
            const [candidates, setCandidates] = React.useState([]);
            const [activities, setActivities] = React.useState([]);
            const [loading, setLoading] = React.useState(true);

            React.useEffect(() => {
                const fetchAllData = async () => {
                    const { data: candidatesData, error: candidatesError } = await supabaseClient.from('users').select('*').eq('role', 'candidate');
                    if (candidatesError) console.error('Error fetching candidates:', candidatesError);
                    else setCandidates(candidatesData);

                    const { data: activitiesData, error: activitiesError } = await supabaseClient.from('activities').select('*').order('created_at', { ascending: false });
                    if (activitiesError) console.error('Error fetching activities', activitiesError);
                    else setActivities(activitiesData);
                    
                    setLoading(false);
                };
                fetchAllData();

                const channel = supabaseClient.channel('public:users_and_activities')
                    .on('postgres_changes', { event: '*', schema: 'public' }, fetchAllData)
                    .subscribe();

                return () => {
                    supabaseClient.removeChannel(channel);
                };
            }, []);
            
            const handleApprove = async (candidateId) => {
                await supabaseClient.from('users').update({ approved: true, role: 'developer' }).eq('id', candidateId);
            };

            const handleReject = async (candidateId) => {
                await supabaseClient.from('users').update({ approved: 'rejected' }).eq('id', candidateId);
            };

            return (
                <div className="grid grid-cols-1 lg:grid-cols-2 gap-8">
                    <div className="bg-white dark:bg-gray-800 p-6 rounded-lg shadow-md">
                        <h2 className="text-2xl font-bold mb-4 text-gray-900 dark:text-white">Candidate Applications</h2>
                        {loading ? <p className="dark:text-gray-300">Loading...</p> : (
                            <div className="space-y-4">
                                {candidates.length > 0 ? candidates.map((c, i) => (
                                    <div key={c.id} className="p-4 border dark:border-gray-700 rounded-lg flex flex-col sm:flex-row justify-between items-start sm:items-center animate-slide-in" style={{animationDelay: `${i*100}ms`}}>
                                        <div>
                                            <p className="font-semibold text-lg dark:text-white">{c.name}</p>
                                            <p className="text-sm text-gray-600 dark:text-gray-400">{c.email}</p>
                                            <p className="text-sm text-gray-600 dark:text-gray-400">Resume: {c.resume?.name || 'Not provided'}</p>
                                        </div>
                                        <div className="mt-4 sm:mt-0 flex items-center space-x-2">
                                            {c.approved === true ? <span className="font-bold text-green-500">Approved</span> :
                                            c.approved === 'rejected' ? <span className="font-bold text-red-500">Rejected</span> :
                                            (<>
                                                <button onClick={() => handleApprove(c.id)} className="bg-green-500 text-white px-3 py-1 rounded hover:bg-green-600 transition-transform hover:scale-105">Approve</button>
                                                <button onClick={() => handleReject(c.id)} className="bg-red-500 text-white px-3 py-1 rounded hover:bg-red-600 transition-transform hover:scale-105">Reject</button>
                                            </>)
                                            }
                                        </div>
                                    </div>
                                )) : <p className="dark:text-gray-300">No new candidates.</p>}
                            </div>
                        )}
                    </div>
                    <div className="bg-white dark:bg-gray-800 p-6 rounded-lg shadow-md">
                        <h2 className="text-2xl font-bold mb-4 text-gray-900 dark:text-white">Team Activity Feed</h2>
                        <div className="space-y-4 max-h-[60vh] overflow-y-auto pr-2">
                            {activities.length > 0 ? activities.map((a, i) => (
                                <div key={a.id} className="p-4 border dark:border-gray-700 rounded-lg animate-slide-in" style={{animationDelay: `${i*100}ms`}}>
                                    <p className="font-bold dark:text-white">{a.user_name}</p>
                                    <p className="text-gray-700 dark:text-gray-300 my-2">{a.text}</p>
                                    <p className="text-xs text-gray-500 dark:text-gray-400">{new Date(a.created_at).toLocaleString()}</p>
                                </div>
                            )) : <p className="dark:text-gray-300">No activities yet.</p>}
                        </div>
                    </div>
                </div>
            );
        };

        const DeveloperDashboard = ({ user }) => {
            const [myActivities, setMyActivities] = React.useState([]);
            const [teamActivities, setTeamActivities] = React.useState([]);
            const [newActivity, setNewActivity] = React.useState('');
            const [submitting, setSubmitting] = React.useState(false);

            React.useEffect(() => {
                const fetchActivities = async () => {
                    const { data, error } = await supabaseClient.from('activities').select('*').order('created_at', { ascending: false });
                    if (error) {
                        console.error('Error fetching activities:', error);
                    } else {
                        setMyActivities(data.filter(a => a.user_id === user.id));
                        setTeamActivities(data.filter(a => a.user_id !== user.id));
                    }
                };
                fetchActivities();

                const channel = supabaseClient.channel('public:activities')
                    .on('postgres_changes', { event: 'INSERT', schema: 'public', table: 'activities' }, (payload) => {
                        const newAct = payload.new;
                        if (newAct.user_id === user.id) {
                            setMyActivities(prev => [newAct, ...prev]);
                        } else {
                            setTeamActivities(prev => [newAct, ...prev]);
                        }
                    })
                    .subscribe();

                return () => {
                    supabaseClient.removeChannel(channel);
                };
            }, [user.id]);

            const handleSubmitActivity = async (e) => {
                e.preventDefault();
                if (!newActivity.trim()) return;
                setSubmitting(true);
                const { error } = await supabaseClient
                    .from('activities')
                    .insert({ text: newActivity, user_id: user.id, user_name: user.name });
                
                if (error) console.error('Error submitting activity:', error);
                else setNewActivity('');
                setSubmitting(false);
            };

            return (
                <div className="grid grid-cols-1 lg:grid-cols-3 gap-8">
                    <div className="lg:col-span-2 bg-white dark:bg-gray-800 p-6 rounded-lg shadow-md">
                        <h2 className="text-2xl font-bold mb-4 text-gray-900 dark:text-white">Post Your Daily Update</h2>
                        <form onSubmit={handleSubmitActivity}>
                            <textarea
                                value={newActivity}
                                onChange={(e) => setNewActivity(e.target.value)}
                                placeholder="What did you work on today?"
                                className="w-full p-2 border rounded dark:bg-gray-700 dark:border-gray-600 dark:text-white focus:ring-2 focus:ring-indigo-500 focus:border-indigo-500 transition"
                                rows="4"
                            ></textarea>
                            <button type="submit" disabled={submitting} className="mt-2 bg-indigo-600 text-white px-4 py-2 rounded-md hover:bg-indigo-700 disabled:bg-indigo-400 transition-transform hover:scale-105">
                                {submitting ? 'Submitting...' : 'Post Update'}
                            </button>
                        </form>

                        <h3 className="text-xl font-bold mt-8 mb-4 text-gray-900 dark:text-white">Team's Recent Activities</h3>
                        <div className="space-y-4 max-h-[40vh] overflow-y-auto pr-2">
                            {teamActivities.length > 0 ? teamActivities.map((a, i) => (
                                <div key={a.id} className="p-4 border dark:border-gray-700 rounded-lg animate-slide-in" style={{animationDelay: `${i*100}ms`}}>
                                    <p className="font-bold dark:text-white">{a.user_name}</p>
                                    <p className="text-gray-700 dark:text-gray-300 my-2">{a.text}</p>
                                    <p className="text-xs text-gray-500 dark:text-gray-400">{new Date(a.created_at).toLocaleString()}</p>
                                </div>
                            )) : <p className="dark:text-gray-300">No team activities yet.</p>}
                        </div>
                    </div>

                    <div className="bg-white dark:bg-gray-800 p-6 rounded-lg shadow-md">
                        <h2 className="text-2xl font-bold mb-4 text-gray-900 dark:text-white">My Past Updates</h2>
                        <div className="space-y-4 max-h-[70vh] overflow-y-auto pr-2">
                            {myActivities.length > 0 ? myActivities.map((a, i) => (
                                <div key={a.id} className="p-4 bg-indigo-50 dark:bg-gray-700/50 rounded-lg animate-slide-in" style={{animationDelay: `${i*100}ms`}}>
                                    <p className="text-gray-700 dark:text-gray-300">{a.text}</p>
                                    <p className="text-xs text-gray-500 dark:text-gray-400 mt-2">{new Date(a.created_at).toLocaleString()}</p>
                                </div>
                            )) : <p className="dark:text-gray-300">You haven't posted any updates.</p>}
                        </div>
                    </div>
                </div>
            );
        };

        const CandidateDashboard = ({ user }) => {
            let statusMessage, statusColor, iconPath;

            if (user.approved === true) {
                statusMessage = "Congratulations! Your application has been approved. You are now a developer.";
                statusColor = "text-green-500";
                iconPath = "M9 12.75L11.25 15 15 9.75M21 12a9 9 0 11-18 0 9 9 0 0118 0z";
            } else if (user.approved === 'rejected') {
                statusMessage = "Thank you for your application. After careful review, we have decided not to move forward at this time.";
                statusColor = "text-red-500";
                iconPath = "M9.75 9.75l4.5 4.5m0-4.5l-4.5 4.5M21 12a9 9 0 11-18 0 9 9 0 0118 0z";
            } else {
                statusMessage = "Your application is pending review by an administrator. We will notify you of any updates.";
                statusColor = "text-yellow-500";
                iconPath = "M12 6v6h4.5m4.5 0a9 9 0 11-18 0 9 9 0 0118 0z";
            }

            return (
                <div className="max-w-2xl mx-auto mt-10 bg-white dark:bg-gray-800 p-8 rounded-lg shadow-md text-center">
                    <Icon path={iconPath} className={`w-16 h-16 mx-auto ${statusColor}`} />
                    <h2 className="text-2xl font-bold my-4 text-gray-900 dark:text-white">Application Status</h2>
                    <p className={`text-lg ${statusColor}`}>
                        {statusMessage}
                    </p>
                    <div className="mt-6 text-left bg-gray-50 dark:bg-gray-700 p-4 rounded-lg">
                        <h3 className="font-semibold dark:text-white">Your Submitted Information:</h3>
                        <p className="dark:text-gray-300"><strong>Name:</strong> {user.name}</p>
                        <p className="dark:text-gray-300"><strong>Email:</strong> {user.email}</p>
                        <p className="dark:text-gray-300"><strong>Resume:</strong> {user.resume?.name || 'Not provided'}</p>
                    </div>
                </div>
            );
        };

        // --- Main Application Component ---
        function App() {
            const [user, setUser] = React.useState(null);
            const [loading, setLoading] = React.useState(true);
            const [authError, setAuthError] = React.useState('');
            const [page, setPage] = React.useState('home');

            React.useEffect(() => {
                const fetchUserProfile = async (sessionUser) => {
                    const { data: profile, error } = await supabaseClient
                        .from('users')
                        .select('*')
                        .eq('id', sessionUser.id)
                        .single();

                    if (error || !profile) {
                        console.error('Profile not found or error fetching profile:', error);
                        setAuthError("Login successful, but your user profile was not found. Please contact an administrator.");
                        supabaseClient.auth.signOut(); // Log out the user if profile is missing
                        setUser(null);
                    } else if (profile) {
                        setAuthError('');
                        setUser({ ...sessionUser, ...profile });
                        setPage('dashboard');
                    }
                };

                const { data: { subscription } } = supabaseClient.auth.onAuthStateChange((_event, session) => {
                    if (session?.user) {
                        fetchUserProfile(session.user);
                    } else {
                        setUser(null);
                        if (page === 'dashboard') setPage('home');
                    }
                    setLoading(false);
                });

                const getInitialSession = async () => {
                    const { data: { session } } = await supabaseClient.auth.getSession();
                    if (session?.user) {
                        await fetchUserProfile(session.user);
                    }
                    setLoading(false);
                };
                
                getInitialSession();

                return () => subscription.unsubscribe();
            }, [page]);

            const handleLogin = async (email, password) => {
                setLoading(true);
                setAuthError('');
                const { error } = await supabaseClient.auth.signInWithPassword({ email, password });
                if (error) {
                    setAuthError(error.message);
                }
                // onAuthStateChange will handle the rest
                setLoading(false);
            };

            const handleRegister = async (name, email, password, resumeInfo) => {
                setLoading(true);
                setAuthError('');
                const { data, error } = await supabaseClient.auth.signUp({ email, password });

                if (error) {
                    setAuthError(error.message);
                    setLoading(false);
                    return;
                }

                if (data.user) {
                    const { error: profileError } = await supabaseClient
                        .from('users')
                        .insert({ id: data.user.id, name, email, role: 'candidate', approved: false, resume: resumeInfo });
                    
                    if (profileError) {
                        setAuthError(profileError.message);
                    }
                }
                setLoading(false);
            };

            const handleLogout = async () => {
                await supabaseClient.auth.signOut();
                setPage('home');
            };

            const renderPage = () => {
                switch (page) {
                    case 'home': return <HomePage setPage={setPage} />;
                    case 'contact': return <ContactPage />;
                    case 'login': return <LoginPage onLogin={handleLogin} onRegister={handleRegister} error={authError} loading={loading} />;
                    case 'dashboard':
                        if (user) return <Dashboard user={user} />;
                        setPage('login'); 
                        return null;
                    default: return <HomePage setPage={setPage} />;
                }
            };

            if (loading && !user) {
                return (
                    <div className="bg-gray-900 text-white min-h-screen flex flex-col justify-center items-center">
                        <Spinner />
                        <p className="mt-4 text-lg">Loading Portal...</p>
                    </div>
                );
            }

            return (
                <div className="min-h-screen">
                    <Navbar user={user} onLogout={handleLogout} setPage={setPage} currentPage={page} />
                    <main className="p-4 sm:p-6 lg:p-8">
                        {renderPage()}
                    </main>
                </div>
            );
        }

        ReactDOM.render(<App />, document.getElementById('root'));
    </script>
</body>
</html>
